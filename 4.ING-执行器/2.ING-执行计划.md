# 1. 导语
如何快速准确地找到需要的数据，是每个数据库需要考虑的核心问题。   

参考《数据库系统概念》书中的描述，查询处理的基本步骤一般包括：语法分析与翻译，优化器，查询计划和执行引擎。    
因此，本文将对照上述流程分析 MongoDB 中请求执行模块的实现。

# 2. 语法分析



# 3. 成本估算与最优执行计划的选择
## RBO、CBO 还是其他？
如何选择最优的执行计划，是数据库优化器需要考虑的问题。    

RBO(Rule-Based Optimizer) 优化器相对简单，根据预先设定的规则，选择最优的执行计划。这种优化器对于数据并不敏感，可能会选择一些代价较大的执行计划。这种策略一般应用于早期的数据库系统。    

CBO(Cost-Based Optimizer) 优化器相对复杂，需要结合实际的运行数据，计算出每个执行计划的代价，然后选择代价最小的执行计划。数据库需要有专门的流程（analyze/vacuum）去更新数据的统计信息（直方图），否则优化器无法正确选择代价最小的执行计划。这种策略在当前的关系型数据库中广泛使用。    

MongoDB 作为 NoSQL 数据库，并没有照搬 RBO 和 CBO 的优化器，个人认为的原因：
1. MongoDB 作为 "schema-free" 的数据库，没有固定的列定义，而且每一列的数据类型也是不固定的，因此本身没有像 SQL 数据库那样的统计信息，因此无法照搬 CBO 优化器。
2. RBO 的缺点非常明显，显然也不是一个很好的选择。

因此，MongoDB 选择了另外一种策略，即根据不同执行计划实际去运行采样，选择代价最小的执行计划。另外结合自身的 planCache 缓存机制，可以减少不必要的代价计算。    
相比传统的 CBO 优化器，MongoDB 的执行计划选择可能需要更多的 IO 和运行时间（因为要实际去执行一次），但是减少了数据统计信息的维护开销。    

# 4. 执行计划与火山模型


# 5. 分片集群的执行计划


# 6. 一些特殊的索引
## 6.1 Geo 地理位置查询



## 6.2 FullText 全文检索



# 7. 总结


# 8. 参考文档
1. 数据库内核杂谈（七）：数据库优化器（上）：https://www.infoq.cn/article/GhhQlV10HWLFQjTTxRtA
2. 数据库内核杂谈（八）：数据库优化器（下）：https://www.infoq.cn/article/JCJyMrGDQHl8osMFQ7ZR
3. 数据库内核杂谈（九）：开源优化器 ORCA：https://www.infoq.cn/article/5o16eHOZ5zk6FzPSJpT2
4. SQL 查询优化原理与 Volcano Optimizer 介绍：https://zhuanlan.zhihu.com/p/48735419
5. Cascades Optimizer：https://zhuanlan.zhihu.com/p/73545345