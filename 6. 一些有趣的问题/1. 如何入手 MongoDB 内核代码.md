# 1. 导语
本文结合自己和周围同事学习 MongoDB 的经历，总结一些学习方法，供参考。

# 2. 一些学习经验
## 2.1 建立预期，做好长期投入的准备
MongoDB 发展至今，已经是一个非常庞大复杂的数据库。如果想要入门并熟悉它，需要有长期投入的思想准备：    
- **文档多**。MongoDB 官网提供了丰富的文档和视频教程方便上手使用。另外，在 github 上提供了 specifications 和 wiki，如果想深入了解 MongoDB 的实现，这将是非常重要的参考资料。    
- **代码多，迭代快**。内核代码已经超过百万行，如果再算上各种编程语言的 driver ，以及 mongodump/mongorestore 这些外围工具，代码量非常大。另外，MongoDB 的迭代也非常迅速，以 3.0 到 5.0 期间的版本为例，基本上每隔 1 年就会推出至少 1 个重磅特性。而且随着 C++ 本身的发展，MongoDB 内核代码也在飞速进化。    
- **特性多**。如果翻开 10 年前的知乎和博客网站，大家对 MongoDB 的印象只是对 JSON 支持好一点的分布式 KV 系统。但是随着近些年的发展，MongoDB 俨然已经成为了数据库的百科全书。相信大家在学习 《DDIA》、《MySQL 45 讲》等各类数据库文献时，都能从 MongoDB 中找到对照。    

所以，如果希望深入了解 MongoDB，需要先建立好自己的心理预期。不要抱着几周速成的想法，要做好长达几年持续学习的准备。

## 2.2 明确目标，指定学习计划
这里先附上 MongoDB 作者在知乎上的高赞回答，可以作为重要参考：https://www.zhihu.com/question/19882468/answer/18329680    

一般来说，比较好的学习路线都是循序渐进的，先熟悉文档并自己搭建并使用 MongoDB，然后再有针对性的学习 MongoDB 代码。    
个人认为，每个人学习 MongoDB 的目的并非完全相同，因此希望了解的东西也可能是不一样的。所以，在开始学习之前，建议先根据自身的诉求和兴趣，明确学习目标和重点，然后有的放矢。    
这里抛砖引玉列举几点：    
- MongoDB 使用者。可能会讲重点放在熟悉官方文档，并了解 driver 和工具的使用和实现。    
- 存储开发者。希望从 MongoDB 中找寻一些设计灵感，并借鉴一些功能实现方式。可能会将重点放在文档模型、复制集和分片集群的实现。    
- 数据库爱好者。可能会将重点放在执行计划、分布式事务等功能的实现。    
- C++ 后台开发者。希望从 MongoDB 代码中学习一些优秀的编码实现。可能会将重点放在线程模型、连接模型、函数式编程、设计模式等方面。    

## 2.3 准备好环境，在实践中学习
工欲善其事，必先利其器。确定好了学习计划之后，就可以开始上手代码了。    

由于我日常工作的开发平台都是 Linux(CentOS)，因此习惯使用 VSCode + SSH-Remote 插件进行远程开发：VSCode 安装在本地的 windows 或者 mac 上，代码的编译、跳转、调试等通过远程插件来操控。再结合VSCode 中的 c++、clangd、git 、gdb等插件，基本就能满足绝大多数需求。    
不同版本的代码，在实现逻辑、代码风格甚至文件路径的组织都存在差别，因此最好是确定一个 release 版本，然后持续研究。可以是自己目前线上使用的版本，或者是当前最新的 release 版本。    

工具和代码都准备完之后，接下来就是看代码做测试了。那么从何看起呢？    
1. 理清代码的基本脉络。首先要理清楚代码的大致架构，比如 mongos 和 mongod 的main 函数入口在哪里，启动流程是怎样的，怎么去 listen 网络请求，又是怎么调用命令的 run 方法。每个目录存放的文件大致对应了哪些功能。要理清这些脉络，可以借助代码中的 sconscript 编译脚本和 gdb 工具。    
2. 分模块，带着问题去学习。不要漫无目的的欣赏代码，这样很容易走神并迷失方向，更好的方式是带着自己的疑问和思路去“审视”和“确认”代码。我的学习步骤一般是：整理一些小问题 => 自己设想解决方法 => 代码阅读+调试验证 => 复盘 MongoDB 这样实现的原因 => 其他数据库如何做的，进行横向对比 => 总结归纳。    

# 3. 准备工具
## 3.1 准备开发机
推荐使用 WSL、Linux云服务器或者 Mac 进行开发。


## 3.2 VSCode 配置
在本地安装好 VSCode 以及 Remote-SSH 插件，然后连接到远程开发机。

然后 git clone 内核代码 docs/building.md 中的指引配置好 gcc 和 python 环境。

**安装 clangd 插件**   
1. 在 VSCode 上远程安装 Clangd 插件
2. 在远程开发机上安装 Clangd 服务。可以根据 VSCode 的提示进行安装，也可以自行下载安装。下载地址：https://github.com/clangd/clangd/releases/download/16.0.2/clangd-linux-16.0.2.zip

**配置 clangd 插件**    

在 VSCode 的 settings 中配置 clangd 参数：     
<TODO clangd 插件的配置图>      

相关参数为：    
```
--background-index
-j=4
--clang-tidy
--all-scopes-completion
--completion-style=detailed
--function-arg-placeholders
--header-insertion=iwyu
```
具体有那些参数，以及各自的含义，可以执行 clangd --help 进行查看。 
## 3.3 调试    
**代码跳转**   

编译 compile_commands.json（以 4.0 版本为例）：   
```
python buildscripts/scons.py compiledb MONGO_VERSION="4.0.3" -j4 CC=/home/pengzhenyi/opt/gcc5.4/bin/gcc CXX=/home/pengzhenyi/opt/gcc5.4/bin/g++
```
编译完成之后，会在当前的工作目录下生成  compile_commands.json 文件。    
VSCode 的 clangd 插件会自动根据这个文件，给代码创建索引：    
<TODO clangd 建索引的示意图>    
索引创建完成之后，就可以非常方便的分析代码了。    

>注： 截止写这篇文章时，VSCode 的默认 c++ 插件也能支持 compile.json 的跳转以及 auto 类型推导等高级特性。但还是能感受到跳转速度和 clangd 插件还是有明显差距，个人推测可能和 clangd 会自动创建索引并进行缓存有关系。

**调试跟踪**    
使用 VSCode + SSH Remote 进行调试。    
编译一个 debug 版本的 mongod（**编译的时候，指定 --dbg=on**）：    
```
python buildscripts/scons.py mongod MONGO_VERSION="4.0.3" --ssl=on -j4 --dbg=on CC=/home/pengzhenyi/opt/gcc5.4/bin/gcc CXX=/home/pengzhenyi/opt/gcc5.4/bin/g++
```
根据自己的机器环境配置VSCode 的 lauch.json 配置，举例如下：    
```
{
    // Use IntelliSense to learn about possible attributes.
    // Hover to view descriptions of existing attributes.
    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        
        {
            "name": "mongod",
            "type": "cppdbg",
            //"request": "launch",
            "request": "attach",
            "program": "${workspaceFolder}/build/debug/mongo/mongod",
            //"args": ["-f", "/data/zhenyipeng/mymongo/conf/mongod.conf"],
            //"stopAtEntry": false,
            //"cwd": "${workspaceFolder}",
            //"environment": [],
            //"externalConsole": false,
            "processId": "${command:pickProcess}",
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ],
            //"preLaunchTask": "C/C++: g++ build active file",
            "miDebuggerPath": "/usr/bin/gdb"
        }
    ]
}
```
**需要说明的是，启动debug 调试时，需要打开 "C/C++" 插件，关闭 clangd 插件，否则可能会有冲突。**

配置完成后，就能使用 VSCode 的 debug 功能 attach 到远程开发机上的 MongoDB 进程，然后打断点调试。

# 4. 一些常用的开发技巧



# 5. 参考文档
1. MongoDB 作者的学习建议：https://www.zhihu.com/question/19882468/answer/18329680
2. MongoDB 官网的学习课程：https://learn.mongodb.com/
