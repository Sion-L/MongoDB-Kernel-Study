MongoDB 使用多个节点组成副本集保证数据高可靠以及服务高可用。和其他使用多节点的分布式系统一样，如何实现多节点的数据一致性，并兼顾系统容错性、高吞吐、低延迟、协议易理解，成为了系统的核心问题。     

目前业界比较流行的一致性协议有 Paxos 和 Raft。[《共识协议的技术变迁》](https://mp.weixin.qq.com/s/UY9TPMcuf0O7xS0kuXTcVw)文中对一致性算法的发展历程进行了非常通俗易懂的描述，推荐学习。   
其中 Paxos 诞生时间比较早，并使用在 Chubby，ZooKeeper 等系统中，但是协议理解起来比较复杂。个人认为学习路径非常陡峭，很多次学着学着就放弃了。     
Raft 的诞生实践较晚，相对 Paxos来说非常好理解。从 Raft 自身的论文也可以看出，从设计之初就考虑了协议的通俗易懂，以及如何指导工程落地。在 etcd，redis 等开源项目中都能看到它的身影。   

MongoDB 使用的一致性协议可以看作是 Raft 协议的一个变种，同样使用了强主的模式来定序，使用日志复制到大多数节点来提交请求。但是 MongoDB 在落地过程中，相比于原生 Raft 协议还是有不少改进，包括但不限于更丰富的节点状态、乱序提交、从节点拉日志、链式复制、可调一致性、Logless Reconfig 等。      
最初看 MongoDB 代码，我感觉代码非常复杂。但是随着对 MongoDB 的理解逐步深入，经历了比较多的业务使用场景，处理了比较多的线上问题处理之后，越来越觉得 MongoDB 一致性协议的牛逼之处。    

本章分为以下几个部分阐述：   
1. 一致性协议：Raft 和 MongoRaft. 首先从原生 Raft 入手，从 Raft 论文简要了解其设计思想和系统流程。然后重点介绍 MongoDB 的一致性协议，并分析相比原生 Raft 所作的改动以及会带来哪些效果。    
2. Oplog. Oplog 是复制集核心中的核心，如何实现高效复制、可见性判断、系统故障恢复、空间回收都是非常关键的话题。
3. ReadPreference 和读写分离。
4. Write concern 和数据安全。
5. Read concern.
